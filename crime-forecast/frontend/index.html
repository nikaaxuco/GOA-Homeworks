<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crime Forecast Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --bg: #0b0d11;
      --panel: #121723;
      --panel-2: #0f1420;
      --border: #273041;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #6366f1;
      --accent-2: #22d3ee;
      --danger: #ff4d4f;
    }

    html, body { height: 100%; margin: 0; }
    body { background: var(--bg); color: var(--text); font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    #app { display: grid; grid-template-rows: 64px 1fr; height: 100%; }

    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 14px; background: linear-gradient(180deg, var(--panel), var(--panel-2));
      color: var(--text); border-bottom: 1px solid var(--border);
      backdrop-filter: blur(8px);
      box-shadow: 0 2px 10px rgba(0,0,0,.35);
    }
    header h1 { font-size: 18px; margin: 0; letter-spacing: .3px; }

    #map { height: 100%; }

    .panel { display: flex; gap: 10px; align-items: center; }
    .panel label { color: var(--muted); font-size: 13px; }

    input[type="number"], select {
      height: 32px; padding: 4px 8px; border-radius: 8px; border: 1px solid var(--border);
      background: #101624; color: var(--text); outline: none;
    }
    input[type="number"]:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99,102,241,.25); }

    button#refresh {
      height: 32px; padding: 0 12px; border: 1px solid transparent; border-radius: 8px; cursor: pointer;
      background: linear-gradient(90deg, var(--accent), var(--accent-2)); color: #0b0d11; font-weight: 600;
      transition: filter .15s ease;
    }
    button#refresh:hover { filter: brightness(1.05); }

    .badge {
      padding: 4px 8px; background: #0d1321; border: 1px solid var(--border); color: var(--muted);
      border-radius: 999px; font-size: 12px;
    }

    .legend { background: #0e1423; color: var(--text); padding: 8px; font: 12px/14px sans-serif; border: 1px solid var(--border); border-radius: 8px; }

    /* Leaflet dark tweaks */
    .leaflet-container { background: var(--bg); }
    .leaflet-control-zoom a { background: #0e1423; color: var(--text); border: 1px solid var(--border); }
    .leaflet-control-zoom a:hover { background: #131a2b; }
    .leaflet-bar a, .leaflet-bar a:hover { color: var(--text); }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #111827; color: var(--text); border: 1px solid var(--border); }

    /* Pulsing incident signal */
    .ping-icon { width: 16px; height: 16px; }
    .ping {
      position: relative; display: block; width: 12px; height: 12px; border-radius: 999px;
      background: var(--danger); box-shadow: 0 0 12px rgba(255, 77, 79, .8);
      transform: translate(2px, 2px);
    }
    .ping::after {
      content: ""; position: absolute; left: 50%; top: 50%; width: 12px; height: 12px; border-radius: 999px;
      border: 2px solid var(--danger); transform: translate(-50%, -50%) scale(1);
      animation: ping-once 1.6s ease-out 1 forwards;
      opacity: .7;
    }
    @keyframes ping-once {
      0% { transform: translate(-50%, -50%) scale(1); opacity: .7; }
      100% { transform: translate(-50%, -50%) scale(3.5); opacity: 0; }
    }
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>Crime Forecast</h1>
    <div class="panel">
      <label for="grid">Grid:</label>
      <input type="number" id="grid" min="10" max="100" step="10" value="50" />
      <label for="horizon">Horizon:</label>
      <select id="horizon">
        <option value="day">Next Day</option>
        <option value="week">Next Week</option>
        <option value="month">Next Month</option>
      </select>
      <button id="refresh">Refresh Forecast</button>
      <span id="status" class="badge">Idle</span>
    </div>
  </header>
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // Init map with dark basemap
  const map = L.map('map').setView([37.775, -122.418], 12);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
  }).addTo(map);

  const incidentLayer = L.layerGroup().addTo(map);
  const gridLayer = L.layerGroup().addTo(map);

  // Ping icon for incident signal
  const pingIcon = L.divIcon({
    className: 'ping-icon',
    html: '<span class="ping"></span>',
    iconSize: [16, 16],
    iconAnchor: [8, 8]
  });

  function showSignal(lat, lng) {
    // Temporary pulsing ripple to highlight new incident
    const ping = L.marker([lat, lng], { icon: pingIcon, interactive: false }).addTo(incidentLayer);
    setTimeout(() => incidentLayer.removeLayer(ping), 1700);
  }

  // Incident SSE stream
  function connectSSE() {
    const es = new EventSource('/api/stream/incidents');
    es.addEventListener('incident', (ev) => {
      const inc = JSON.parse(ev.data);
      // Persistent dot with popup
      const marker = L.circleMarker([inc.lat, inc.lng], {
        radius: 5, color: '#ff4d4f', fillColor: '#ff4d4f', fillOpacity: 0.9
      }).bindPopup(`<b>${inc.type}</b><br/>${new Date(inc.occurredAt).toLocaleString()}`);
      marker.addTo(incidentLayer);
      // Visual signal
      showSignal(inc.lat, inc.lng);
    });
    es.onerror = () => { console.warn('SSE disconnected, retrying...'); setTimeout(connectSSE, 3000); };
  }
  connectSSE();

  function colorForRisk(v) {
    // Red emphasis on dark background
    const t = Math.max(0, Math.min(1, v));
    const r = Math.floor(255 * t);
    const g = Math.floor(60 * (1 - t));
    const b = Math.floor(90 * (1 - t));
    return `rgba(${r},${g},${b},0.28)`;
  }

  async function fetchForecast() {
    const grid = document.getElementById('grid').value;
    const horizon = document.getElementById('horizon').value;
    const status = document.getElementById('status');
    status.textContent = 'Loading...';
    try {
      const res = await fetch(`/api/forecast?grid=${grid}&horizon=${horizon}`);
      const data = await res.json();
      renderGrid(data);
      status.textContent = `Updated ${new Date().toLocaleTimeString()}`;
    } catch (e) {
      console.error(e);
      status.textContent = 'Error';
    }
  }

  function renderGrid(data) {
    gridLayer.clearLayers();
    const riskVals = data.result.map(c => c.risk);
    const min = Math.min(...riskVals), max = Math.max(...riskVals) || 1;
    data.result.forEach(cell => {
      const t = (cell.risk - min) / (max - min || 1);
      const bounds = [[cell.bounds.south, cell.bounds.west], [cell.bounds.north, cell.bounds.east]];
      L.rectangle(bounds, { color: 'transparent', weight: 0, fillColor: colorForRisk(t), fillOpacity: 0.35 }).addTo(gridLayer);
    });
  }

  document.getElementById('refresh').addEventListener('click', fetchForecast);
  fetchForecast();
</script>
</body>
</html>